<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Post Feed</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="./feedPage.css" />
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">
</head>
  <body class="bg-light min-vh-100 d-flex flex-column">
    <header class="container py-2">
      <div class="d-flex justify-content-end gap-2">
        <button class="btn btn-primary btn-sm" onclick="window.location.href='./post.html'">New Post</button>
        <button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>    
      </div>
    </header>
    <main class="container my-3 flex-grow-1">
      <div class="allPost" id="postContainer"></div>
    </main>
    <script>
      document.getElementById("logoutBtn").addEventListener("click",()=>{
        localStorage.removeItem('userID');
        window.location.href='./login.html'
      })
      document.addEventListener("DOMContentLoaded",async()=>{
        const userID=localStorage.getItem('userID')
        if(!userID){
          window.location.href="./login.html"
          return
        }
        const body=new URLSearchParams();
        body.append('userID',userID)
        try{
          const response=await fetch("/feedPost",{
            method:"POST",
            headers:{
              "Content-Type":"application/x-www-form-urlencoded"
            },
            body
          });
          if(!response.ok){
            console.log("Failed to fetch Posts")
            return;
          }
          const posts=await response.json()
          const container=document.getElementById('postContainer')
          container.innerHTML=""

          if(posts.length==0){
            container.innerHTML="<p class='text-center mt-4'>No Posts yet. Click 'new Posts' to write your day</p>";
            return;
          }
          posts.forEach((post) => {
            const div=document.createElement("div")
            div.className="Post mb-3"

            const fullDesc=post.postDescription || "";
            const words=fullDesc.trim().split(/\s+/);
            let preview=words.slice(0,30).join(' ');
            if(words.length>30) preview+=" ..."; 
            div.innerHTML=`
            <h2 class="h5 mb-2">${post.postTitle}</h2>
            <p class="mb-3">${preview}</p>
            <div class="d-flex flex-wrap gap-2">
              <a href="./dedicatedPage.html?id=${post.ID}" class="btn btn-sm btn-outline-primary viewButton">View Post</a>
              <button class="btn btn-sm btn-secondary edit-btn" data-id="${post.ID}">Edit Post</button>
              <button class="btn btn-sm btn-danger delete-btn" data-id="${post.ID}">Delete Post</button>
            </div>
              `;
            container.appendChild(div)
          });
          container.addEventListener("click",async(e)=>{
            const editBtn=e.target.closest(".edit-btn");
            const deleteBtn=e.target.closest(".delete-btn")
            if(editBtn){
              const id=editBtn.dataset.id;
              window.location.href=`./post.html?id=${id}`
            }
            if(deleteBtn){
              const id=deleteBtn.dataset.id
              const deleteBody=new URLSearchParams()
              deleteBody.append("postID",id)
              
              const delRes=await fetch("/deletePost",{
                method:"POST",
                headers:{
                  "Content-Type":"application/x-www-form-urlencoded"
                },
                body:deleteBody
              });
              if(delRes.ok){
                deleteBtn.closest(".Post").remove()
              }else{
                alert("Failed to delete")
              }
            }
          })
        }catch(err){
          console.error("Error loading posts:", err);
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js" integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" crossorigin="anonymous"></script>  </body>
</html>